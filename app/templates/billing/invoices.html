{% extends "base.html" %}

{% block title %}Invoices - RADIUS Dashboard{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Invoices</h1>
            <p class="text-gray-600">Kelola tagihan dan invoice pelanggan</p>
        </div>
        <button onclick="generateInvoices()" 
                class="mt-4 md:mt-0 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors">
            <i class="fas fa-plus"></i>
            <span>Generate Invoices</span>
        </button>
    </div>

    <!-- Invoice Table -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">Daftar Invoice</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice #</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pelanggan</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paket</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Periode</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody id="invoicesTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Data akan diisi oleh JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    console.log('jQuery loaded, loading invoices...');
    loadInvoices();
});

function loadInvoices() {
    $.get('/api/billing/invoices', function(invoices) {
        console.log('Invoices data received:', invoices);
        
        const tbody = $('#invoicesTableBody');
        tbody.empty();
        
        if (!invoices || invoices.length === 0) {
            tbody.append(`
                <tr>
                    <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                        Tidak ada invoice ditemukan
                    </td>
                </tr>
            `);
            return;
        }
        
        invoices.forEach(invoice => {
            let statusBadge = '';
            if (invoice.status === 'paid') {
                statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Lunas</span>';
            } else if (invoice.status === 'pending') {
                statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pending</span>';
            } else {
                statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">${invoice.status}</span>`;
            }
            
            const row = `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${invoice.invoice_number || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${invoice.full_name}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${invoice.package_name}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${invoice.period_month}/${invoice.period_year}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        Rp ${parseInt(invoice.amount).toLocaleString('id-ID')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(invoice.due_date).toLocaleDateString('id-ID')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${statusBadge}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="viewInvoice(${invoice.id})" 
                                class="text-blue-600 hover:text-blue-900 bg-blue-50 hover:bg-blue-100 px-3 py-1 rounded-md text-xs transition-colors">
                            <i class="fas fa-eye mr-1"></i>View
                        </button>
                        ${invoice.status === 'pending' ? `
                        <button onclick="markAsPaid(${invoice.id})" 
                                class="text-green-600 hover:text-green-900 bg-green-50 hover:bg-green-100 px-3 py-1 rounded-md text-xs transition-colors">
                            <i class="fas fa-check mr-1"></i>Pay
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    }).fail(function(xhr, status, error) {
        console.error('Error loading invoices:', error);
        showNotification('Error loading invoices: ' + error, 'error');
    });
}

function generateInvoices() {
    if (confirm('Generate invoices untuk bulan ini?')) {
        $.post('/api/billing/invoices/generate')
        .done(function(response) {
            if (response.success) {
                showNotification('Invoices berhasil digenerate', 'success');
                loadInvoices();
            } else {
                showNotification('Error: ' + response.error, 'error');
            }
        })
        .fail(function(xhr, status, error) {
            console.error('Generate error:', error);
            showNotification('Gagal generate invoices: ' + error, 'error');
        });
    }
}

function viewInvoice(invoiceId) {
    // Method yang tidak diblok popup blocker
    const url = `/billing/invoice/${invoiceId}`;
    
    // Coba method 1: form submit
    const form = document.createElement('form');
    form.method = 'GET';
    form.action = url;
    form.target = '_blank';
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}

function markAsPaid(invoiceId) {
    if (confirm('Tandai invoice sebagai lunas?')) {
        $.post(`/api/billing/invoices/pay/${invoiceId}`, {
            payment_method: 'cash',
            notes: 'Pembayaran manual'
        }, function(response) {
            if (response.success) {
                showNotification('Invoice berhasil ditandai sebagai lunas', 'success');
                loadInvoices();
            } else {
                showNotification('Error: ' + response.error, 'error');
            }
        });
    }
}
</script>
{% endblock %}
