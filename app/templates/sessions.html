{% extends "base.html" %}

{% block title %}Sessions - RADIUS Manager{% endblock %}
{% block page_title %}Active Sessions{% endblock %}
{% block page_subtitle %}Live PPPoE Connections & Monitoring{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-semibold text-gray-800">Active PPPoE Sessions</h3>
            <button onclick="loadSessions()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors">
                <i class="fas fa-sync-alt"></i>
                <span>Refresh</span>
            </button>
        </div>

        <div id="sessionsList" class="space-y-4">
            <div class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-blue-600 text-2xl mb-2"></i>
                <p class="text-gray-600">Loading active sessions...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load sessions list
    async function loadSessions() {
        const data = await apiCall('/api/sessions');
        const sessionsList = document.getElementById('sessionsList');
        
        if (data.error) {
            sessionsList.innerHTML = `
                <div class="text-center py-8 text-red-600">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p>Error loading sessions: ${data.error}</p>
                </div>
            `;
            return;
        }

        if (data.length === 0) {
            sessionsList.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-plug text-2xl mb-2"></i>
                    <p>No active sessions</p>
                    <p class="text-sm">All PPPoE connections are idle</p>
                </div>
            `;
            return;
        }

        sessionsList.innerHTML = data.map(session => `
            <div class="bg-gray-50 rounded-lg p-4 border border-green-200 hover:border-green-300 transition-colors">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <h4 class="font-semibold text-gray-800">${session.username}</h4>
                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">LIVE</span>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600">
                    <div>
                        <span class="font-medium">NAS IP:</span>
                        <div class="text-gray-800 font-mono">${session.nasipaddress}</div>
                    </div>
                    <div>
                        <span class="font-medium">Start Time:</span>
                        <div class="text-gray-800">${new Date(session.acctstarttime).toLocaleString()}</div>
                    </div>
                    <div>
                        <span class="font-medium">Duration:</span>
                        <div class="text-gray-800">${Math.floor(session.acctsessiontime / 3600)}h ${Math.floor((session.acctsessiontime % 3600) / 60)}m</div>
                    </div>
                    <div>
                        <span class="font-medium">Session ID:</span>
                        <div class="text-gray-800 font-mono text-xs">${session.acctsessionid}</div>
                    </div>
                </div>
                ${session.acctinputoctets || session.acctoutputoctets ? `
                    <div class="mt-3 grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-blue-50 p-2 rounded">
                            <span class="font-medium text-blue-700">Download:</span>
                            <div class="text-blue-800">${formatBytes(session.acctinputoctets || 0)}</div>
                        </div>
                        <div class="bg-green-50 p-2 rounded">
                            <span class="font-medium text-green-700">Upload:</span>
                            <div class="text-green-800">${formatBytes(session.acctoutputoctets || 0)}</div>
                        </div>
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    // Format bytes to human readable
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Auto-refresh every 10 seconds
    loadSessions();
    setInterval(loadSessions, 10000);
</script>
{% endblock %}
