{% extends "base.html" %}
{% block title %}Backup & Restore - RADIUS Manager{% endblock %}
{% block page_title %}Backup & Restore{% endblock %}
{% block page_subtitle %}Database Backup Management & Recovery{% endblock %}
{% block content %}
<div class="fade-in">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
        <div>
            <h2 class="text-xl font-semibold text-gray-800">Database Backup Management</h2>
            <p class="text-gray-600">Create, download, and restore database backups</p>
        </div>
        <div class="flex space-x-3 mt-4 md:mt-0">
            <button onclick="uploadBackup()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors">
                <i class="fas fa-upload"></i>
                <span>Upload Backup</span>
            </button>
            <button onclick="createBackup()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors">
                <i class="fas fa-database"></i>
                <span>Create Backup</span>
            </button>
        </div>
    </div>

    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-yellow-800">Important Information</h3>
                <div class="mt-2 text-sm text-yellow-700">
                    <ul class="list-disc list-inside space-y-1">
                        <li>Always create a backup before performing major changes</li>
                        <li>Store backup files in a safe location outside the server</li>
                        <li>Restore operation will overwrite all current data</li>
                        <li>Backup includes: Users, NAS, Sessions, Billing data</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-blue-700 font-medium">Total Backups</p>
                    <p id="totalBackups" class="text-3xl font-bold text-blue-900 mt-1">0</p>
                </div>
                <div class="bg-blue-200 rounded-full p-3">
                    <i class="fas fa-archive text-blue-700 text-2xl"></i>
                </div>
            </div>
        </div>
       
        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-green-700 font-medium">Latest Backup</p>
                    <p id="latestBackup" class="text-sm font-bold text-green-900 mt-2">-</p>
                </div>
                <div class="bg-green-200 rounded-full p-3">
                    <i class="fas fa-clock text-green-700 text-2xl"></i>
                </div>
            </div>
        </div>
       
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-purple-700 font-medium">Total Size</p>
                    <p id="totalSize" class="text-2xl font-bold text-purple-900 mt-1">0 MB</p>
                </div>
                <div class="bg-purple-200 rounded-full p-3">
                    <i class="fas fa-hdd text-purple-700 text-2xl"></i>
                </div>
            </div>
        </div>
       
        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-6 border border-orange-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-orange-700 font-medium">Auto Backup</p>
                    <p class="text-lg font-bold text-orange-900 mt-2">Manual</p>
                </div>
                <div class="bg-orange-200 rounded-full p-3">
                    <i class="fas fa-robot text-orange-700 text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800">Available Backups</h3>
                <button onclick="loadBackups()" class="text-blue-600 hover:text-blue-800 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
            </div>
        </div>
       
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Filename</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="backupsTable" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                            <div class="animate-spin h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                            <p>Loading backups...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Upload Backup File</h3>
            <button onclick="hideUploadModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Backup File (.sql)</label>
                <input type="file" id="backupFile" accept=".sql" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <p class="text-xs text-gray-500 mt-2">Only .sql files are allowed</p>
            </div>
            <div class="flex space-x-3">
                <button type="button" onclick="hideUploadModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">Cancel</button>
                <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">Upload</button>
            </div>
        </form>
    </div>
</div>

<!-- Restore Confirmation Modal -->
<div id="restoreModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-3xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Restore Database?</h3>
            <p class="text-sm text-gray-600 mb-4">This will restore the database from:</p>
            <p class="text-sm font-semibold text-gray-800 mb-4" id="restoreFilename">-</p>
            <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                <p class="text-xs text-red-700 font-medium">WARNING: This will overwrite ALL current data!</p>
            </div>
        </div>
        <div class="flex space-x-3 mt-6">
            <button type="button" onclick="hideRestoreModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">Cancel</button>
            <button type="button" onclick="confirmRestore()" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">Restore Now</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Tidak pakai variabel global backupToRestore lagi â†’ lebih aman
document.addEventListener('DOMContentLoaded', function() {
    loadBackups();
});

async function loadBackups() {
    try {
        const response = await fetch('/api/backup/list');
        const data = await response.json();
       
        if (data.success) {
            const backups = data.backups || [];
            updateStatistics(backups);
            renderBackupsTable(backups);
        } else {
            showNotification('Error loading backups: ' + data.error, 'error');
        }
    } catch (error) {
        showNotification('Error loading backups', 'error');
    }
}

function updateStatistics(backups) {
    document.getElementById('totalBackups').textContent = backups.length;
   
    if (backups.length > 0) {
        document.getElementById('latestBackup').textContent = backups[0].created_at;
        const totalSize = backups.reduce((sum, b) => sum + b.size, 0);
        document.getElementById('totalSize').textContent = formatBytes(totalSize);
    } else {
        document.getElementById('latestBackup').textContent = 'No backups yet';
        document.getElementById('totalSize').textContent = '0 MB';
    }
}

function renderBackupsTable(backups) {
    const tbody = document.getElementById('backupsTable');
   
    if (backups.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-inbox text-3xl text-gray-300 mb-2"></i>
                    <p class="font-medium">No backups available</p>
                    <p class="text-sm mt-1">Click "Create Backup" to create your first backup</p>
                </td>
            </tr>
        `;
        return;
    }
   
    tbody.innerHTML = backups.map(backup => `
        <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <i class="fas fa-file-archive text-blue-600 mr-3 text-lg"></i>
                    <div class="text-sm font-medium text-gray-900">${backup.filename}</div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${backup.created_at}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-sm font-medium text-gray-700">${backup.size_human}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex space-x-2">
                    <button onclick="downloadBackup('${backup.filename}')" class="text-blue-600 hover:text-blue-900 bg-blue-50 hover:bg-blue-100 px-3 py-1 rounded transition-colors">
                        <i class="fas fa-download mr-1"></i>Download
                    </button>
                    <button onclick="showRestoreModal('${backup.filename}')" class="text-green-600 hover:text-green-900 bg-green-50 hover:bg-green-100 px-3 py-1 rounded transition-colors">
                        <i class="fas fa-undo mr-1"></i>Restore
                    </button>
                    <button onclick="deleteBackup('${backup.filename}')" class="text-red-600 hover:text-red-900 bg-red-50 hover:bg-red-100 px-3 py-1 rounded transition-colors">
                        <i class="fas fa-trash mr-1"></i>Delete
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

async function createBackup() {
    if (!confirm('Create a new database backup?')) return;
    showNotification('Creating backup... Please wait', 'info');
    try {
        const response = await fetch('/api/backup/create', {method: 'POST'});
        const data = await response.json();
        if (data.success) {
            showNotification('Backup created successfully: ' + data.filename, 'success');
            loadBackups();
        } else {
            showNotification('Error creating backup: ' + data.error, 'error');
        }
    } catch (error) {
        showNotification('Error creating backup', 'error');
    }
}

function downloadBackup(filename) {
    window.location.href = `/api/backup/download/${filename}`;
}

function showRestoreModal(filename) {
    document.getElementById('restoreFilename').textContent = filename;
    document.getElementById('restoreModal').classList.remove('hidden');
}

function hideRestoreModal() {
    document.getElementById('restoreModal').classList.add('hidden');
    document.getElementById('restoreFilename').textContent = '-';
}

// PERBAIKAN UTAMA: ambil filename langsung dari modal, bukan variabel global
async function confirmRestore() {
    const filename = document.getElementById('restoreFilename').textContent.trim();
    
    if (!filename || filename === '-' || filename === '') {
        showNotification('No backup file selected', 'error');
        return;
    }

    hideRestoreModal();
    showNotification('Restoring database... This may take a few minutes', 'info');

    try {
        const response = await fetch('/api/backup/restore', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: filename })
        });

        const data = await response.json();

        if (data.success) {
            showNotification('Database restored successfully! Reloading...', 'success');
            setTimeout(() => { window.location.reload(); }, 3000);
        } else {
            showNotification('Restore failed: ' + data.error, 'error');
        }
    } catch (error) {
        showNotification('Error restoring backup', 'error');
    }
}

async function deleteBackup(filename) {
    if (!confirm(`Delete backup: ${filename}?`)) return;
    try {
        const response = await fetch(`/api/backup/delete/${filename}`, {method: 'DELETE'});
        const data = await response.json();
        if (data.success) {
            showNotification('Backup deleted successfully', 'success');
            loadBackups();
        } else {
            showNotification('Error: ' + data.error, 'error');
        }
    } catch (error) {
        showNotification('Error deleting backup', 'error');
    }
}

function uploadBackup() {
    document.getElementById('uploadModal').classList.remove('hidden');
}

function hideUploadModal() {
    document.getElementById('uploadModal').classList.add('hidden');
    document.getElementById('uploadForm').reset();
}

document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('backupFile');
    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('backup_file', file);

    showNotification('Uploading backup...', 'info');

    try {
        const response = await fetch('/api/backup/upload', {method: 'POST', body: formData});
        const data = await response.json();
        if (data.success) {
            showNotification('Backup uploaded successfully', 'success');
            hideUploadModal();
            loadBackups();
        } else {
            showNotification('Error: ' + data.error, 'error');
        }
    } catch (error) {
        showNotification('Error uploading backup', 'error');
    }
});

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 bg-${type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue'}-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity`;
    notification.innerHTML = `<div class="flex items-center space-x-2"><i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i><span>${message}</span></div>`;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 5000);
}
</script>
{% endblock %}
