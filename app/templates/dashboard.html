{% extends "base.html" %}

{% block title %}Dashboard - RADIUS Manager{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Real-time RADIUS Statistics & Monitoring{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Users -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Total Users</p>
                    <h3 id="totalUsers" class="text-3xl font-bold text-gray-800 mt-2">-</h3>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-users text-blue-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <div class="flex items-center text-green-600 text-sm">
                    <i class="fas fa-arrow-up mr-1"></i>
                    <span>Active PPPoE users</span>
                </div>
            </div>
        </div>

        <!-- Active Sessions -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Active Sessions</p>
                    <h3 id="activeSessions" class="text-3xl font-bold text-gray-800 mt-2">-</h3>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-plug text-green-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <div class="flex items-center text-green-600 text-sm">
                    <i class="fas fa-signal mr-1"></i>
                    <span>Live connections</span>
                </div>
            </div>
        </div>

        <!-- Today Auth -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Today Auth</p>
                    <h3 id="todayAuth" class="text-3xl font-bold text-gray-800 mt-2">-</h3>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <div class="flex items-center text-green-600 text-sm">
                    <i class="fas fa-bolt mr-1"></i>
                    <span>Authentication attempts</span>
                </div>
            </div>
        </div>

        <!-- NAS Devices -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">NAS Devices</p>
                    <h3 id="totalNas" class="text-3xl font-bold text-gray-800 mt-2">-</h3>
                </div>
                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-server text-orange-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <div class="flex items-center text-green-600 text-sm">
                    <i class="fas fa-network-wired mr-1"></i>
                    <span>Network devices</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Section (bisa dihapus setelah fix) -->
    <div id="debugInfo" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 hidden">
        <h4 class="font-semibold text-yellow-800 mb-2">Debug Information</h4>
        <pre id="debugData" class="text-sm text-yellow-700"></pre>
    </div>

    <!-- Charts and Additional Info -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Quick Actions -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
            <div class="grid grid-cols-2 gap-4">
                <a href="/nas" class="flex items-center p-4 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors group">
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3 group-hover:bg-blue-200 transition-colors">
                        <i class="fas fa-plus text-blue-600"></i>
                    </div>
                    <div>
                        <p class="font-medium text-gray-800">Add NAS</p>
                        <p class="text-sm text-gray-600">New device</p>
                    </div>
                </a>
                
                <a href="/users" class="flex items-center p-4 border border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors group">
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3 group-hover:bg-green-200 transition-colors">
                        <i class="fas fa-user-plus text-green-600"></i>
                    </div>
                    <div>
                        <p class="font-medium text-gray-800">Add User</p>
                        <p class="text-sm text-gray-600">PPPoE account</p>
                    </div>
                </a>
                
                <a href="/sessions" class="flex items-center p-4 border border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors group">
                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3 group-hover:bg-purple-200 transition-colors">
                        <i class="fas fa-eye text-purple-600"></i>
                    </div>
                    <div>
                        <p class="font-medium text-gray-800">View Sessions</p>
                        <p class="text-sm text-gray-600">Active connections</p>
                    </div>
                </a>
                
                <a href="/logs" class="flex items-center p-4 border border-gray-200 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-colors group">
                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center mr-3 group-hover:bg-orange-200 transition-colors">
                        <i class="fas fa-file-alt text-orange-600"></i>
                    </div>
                    <div>
                        <p class="font-medium text-gray-800">View Logs</p>
                        <p class="text-sm text-gray-600">Authentication logs</p>
                    </div>
                </a>
            </div>
        </div>

        <!-- System Status -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">System Status</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                        <span class="text-gray-700">Database Connection</span>
                    </div>
                    <span class="text-green-600 font-medium">Healthy</span>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                        <span class="text-gray-700">RADIUS Service</span>
                    </div>
                    <span class="text-green-600 font-medium">Running</span>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                        <span class="text-gray-700">Web Interface</span>
                    </div>
                    <span class="text-green-600 font-medium">Online</span>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-blue-500 rounded-full mr-3"></div>
                        <span class="text-gray-700">Last Update</span>
                    </div>
                    <span id="lastUpdate" class="text-gray-600 text-sm">Just now</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load stats on page load
    async function loadStats() {
        try {
            console.log('ðŸŸ¢ Loading stats...');
            const response = await fetch('/api/stats');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('ðŸ“Š Stats data:', data);
            
            if (data.error) {
                showNotification('Failed to load stats: ' + data.error, 'error');
                // Show debug info
                document.getElementById('debugInfo').classList.remove('hidden');
                document.getElementById('debugData').textContent = 'Error: ' + data.error;
                return;
            }

            // Update stats
            document.getElementById('totalUsers').textContent = data.total_users || '0';
            document.getElementById('activeSessions').textContent = data.active_sessions || '0';
            document.getElementById('todayAuth').textContent = data.today_auth || '0';
            document.getElementById('totalNas').textContent = data.total_nas || '0';
            
            // Update timestamp
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            // Hide debug info if successful
            document.getElementById('debugInfo').classList.add('hidden');
            
        } catch (error) {
            console.error('ðŸ”´ Error loading stats:', error);
            showNotification('Failed to load stats: ' + error.message, 'error');
            
            // Show debug info
            document.getElementById('debugInfo').classList.remove('hidden');
            document.getElementById('debugData').textContent = 'Fetch error: ' + error.message;
        }
    }

    // Manual refresh function
    window.refreshDashboard = function() {
        loadStats();
        showNotification('Dashboard refreshed', 'success');
    };

    // Auto-refresh every 10 seconds (lebih cepat untuk testing)
    loadStats();
    setInterval(loadStats, 10000);

    // Add refresh button event listener
    document.addEventListener('DOMContentLoaded', function() {
        // Add refresh button to header
        const header = document.querySelector('header .flex.items-center.space-x-4');
        if (header) {
            const refreshBtn = document.createElement('button');
            refreshBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors';
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i><span>Refresh</span>';
            refreshBtn.onclick = refreshDashboard;
            header.appendChild(refreshBtn);
        }
        
        // Smooth loading animation
        const stats = document.querySelectorAll('[id$="Users"], [id$="Sessions"], [id$="Auth"], [id$="Nas"]');
        let delay = 0;
        stats.forEach(stat => {
            setTimeout(() => {
                stat.classList.add('fade-in');
            }, delay);
            delay += 100;
        });
    });
</script>
{% endblock %}
