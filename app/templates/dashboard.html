{% extends "base.html" %}

{% block title %}Dashboard - RADIUS Manager{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Real-time RADIUS Statistics & Monitoring{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Stats Grid - Fixed Layout -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- Total Users -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium mb-1">Total Users</p>
                    <h3 id="totalUsers" class="text-2xl font-bold text-gray-800">-</h3>
                </div>
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-users text-blue-600"></i>
                </div>
            </div>
            <div class="mt-2 flex items-center text-green-600 text-xs">
                <i class="fas fa-arrow-up mr-1"></i>
                <span>Active PPPoE users</span>
            </div>
        </div>

        <!-- Active Sessions -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium mb-1">Active Sessions</p>
                    <h3 id="activeSessions" class="text-2xl font-bold text-gray-800">-</h3>
                </div>
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-plug text-green-600"></i>
                </div>
            </div>
            <div class="mt-2 flex items-center text-green-600 text-xs">
                <i class="fas fa-signal mr-1"></i>
                <span>Live connections</span>
            </div>
        </div>

        <!-- Auth Attempts -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium mb-1">Auth Attempts</p>
                    <h3 id="todayAuth" class="text-2xl font-bold text-gray-800">-</h3>
                </div>
                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-line text-purple-600"></i>
                </div>
            </div>
            <div class="mt-2 flex items-center text-green-600 text-xs">
                <i class="fas fa-bolt mr-1"></i>
                <span>Today's authentication</span>
            </div>
        </div>

        <!-- NAS Devices -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium mb-1">NAS Devices</p>
                    <h3 id="totalNas" class="text-2xl font-bold text-gray-800">-</h3>
                </div>
                <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-server text-orange-600"></i>
                </div>
            </div>
            <div class="mt-2 flex items-center text-green-600 text-xs">
                <i class="fas fa-network-wired mr-1"></i>
                <span>Network devices</span>
            </div>
        </div>
    </div>

    <!-- Main Content - Simplified Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Quick Actions - Full width on mobile -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
            <div class="grid grid-cols-2 gap-3">
                <a href="/nas" class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-2">
                        <i class="fas fa-plus text-blue-600"></i>
                    </div>
                    <p class="font-medium text-gray-800 text-sm">Add NAS</p>
                    <p class="text-xs text-gray-600 mt-1">Network device</p>
                </a>
                
                <a href="/users" class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors text-center">
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mb-2">
                        <i class="fas fa-user-plus text-green-600"></i>
                    </div>
                    <p class="font-medium text-gray-800 text-sm">Add User</p>
                    <p class="text-xs text-gray-600 mt-1">PPPoE account</p>
                </a>
                
                <a href="/sessions" class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-center">
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mb-2">
                        <i class="fas fa-eye text-purple-600"></i>
                    </div>
                    <p class="font-medium text-gray-800 text-sm">View Sessions</p>
                    <p class="text-xs text-gray-600 mt-1">Live connections</p>
                </a>
                
                <a href="/billing/customers" class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 transition-colors text-center">
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center mb-2">
                        <i class="fas fa-user-plus text-red-600"></i>
                    </div>
                    <p class="font-medium text-gray-800 text-sm">Add Customer</p>
                    <p class="text-xs text-gray-600 mt-1">Billing account</p>
                </a>
            </div>
        </div>

        <!-- System Status -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">System Status</h3>
            <div class="space-y-3">
                <div class="flex items-center justify-between py-2">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                        <span class="text-sm text-gray-700">Database</span>
                    </div>
                    <span class="text-green-600 text-sm font-medium">Operational</span>
                </div>
                
                <div class="flex items-center justify-between py-2">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                        <span class="text-sm text-gray-700">RADIUS Service</span>
                    </div>
                    <span class="text-green-600 text-sm font-medium">Running</span>
                </div>
                
                <div class="flex items-center justify-between py-2">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                        <span class="text-sm text-gray-700">Web Interface</span>
                    </div>
                    <span class="text-green-600 text-sm font-medium">Online</span>
                </div>
                
                <div class="flex items-center justify-between py-2 border-t border-gray-100 pt-3">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                        <span class="text-sm text-gray-700">Last Update</span>
                    </div>
                    <span id="lastUpdate" class="text-gray-600 text-xs font-mono">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Billing Overview -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Billing Overview</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="activeCustomers">-</div>
                    <div class="text-sm text-gray-600">Active Customers</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-600" id="pendingInvoices">-</div>
                    <div class="text-sm text-gray-600">Pending Invoices</div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="text-center">
                    <div class="text-xl font-bold text-green-600" id="todayIncome">-</div>
                    <div class="text-sm text-gray-600">Today's Income</div>
                </div>
                <div class="text-center">
                    <div class="text-xl font-bold text-purple-600" id="monthlyIncome">-</div>
                    <div class="text-sm text-gray-600">Monthly Income</div>
                </div>
            </div>
            <div class="mt-4 flex space-x-2">
                <a href="/billing/invoices" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-center py-2 px-3 rounded text-sm transition-colors">
                    View Invoices
                </a>
                <a href="/billing/customers" class="flex-1 bg-green-600 hover:bg-green-700 text-white text-center py-2 px-3 rounded text-sm transition-colors">
                    Add Customer
                </a>
            </div>
        </div>
    </div>

    <!-- Bottom Sections -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Recent Activity -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Recent Activity</h3>
                <span class="text-xs text-gray-500">Last 30 minutes</span>
            </div>
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                        <span class="text-sm text-gray-700">User login successful</span>
                    </div>
                    <span class="text-xs text-gray-500">2 min ago</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                        <span class="text-sm text-gray-700">New session started</span>
                    </div>
                    <span class="text-xs text-gray-500">5 min ago</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                        <span class="text-sm text-gray-700">NAS device check</span>
                    </div>
                    <span class="text-xs text-gray-500">8 min ago</span>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Performance Metrics</h3>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>System Load</span>
                        <span id="systemLoad">-</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="systemLoadBar" class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Memory Usage</span>
                        <span id="memoryUsage">-</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="memoryUsageBar" class="bg-blue-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Database Connections</span>
                        <span id="dbConnections">-</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="dbConnectionsBar" class="bg-purple-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Format timestamp yang profesional
    function formatTimestamp(date = new Date()) {
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        }).replace(/(\d+)\/(\d+)\/(\d+),/, '$3-$1-$2');
    }

    // Update timestamp
    function updateTimestamp() {
        const timestampElement = document.getElementById('lastUpdate');
        if (timestampElement) {
            timestampElement.textContent = formatTimestamp();
        }
    }

    // Simulate performance metrics
    function updatePerformanceMetrics() {
        const systemLoad = Math.floor(Math.random() * 30) + 10; // 10-40%
        const memoryUsage = Math.floor(Math.random() * 40) + 30; // 30-70%
        const dbConnections = Math.floor(Math.random() * 20) + 5; // 5-25
        
        document.getElementById('systemLoad').textContent = systemLoad + '%';
        document.getElementById('systemLoadBar').style.width = systemLoad + '%';
        
        document.getElementById('memoryUsage').textContent = memoryUsage + '%';
        document.getElementById('memoryUsageBar').style.width = memoryUsage + '%';
        
        document.getElementById('dbConnections').textContent = dbConnections;
        document.getElementById('dbConnectionsBar').style.width = Math.min(dbConnections * 4, 100) + '%';
    }

    // Load billing stats
    async function loadBillingStats() {
        try {
            const response = await fetch('/api/billing/stats');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.error) {
                console.log('Billing stats error:', data.error);
                return;
            }

            // Update billing stats
            document.getElementById('activeCustomers').textContent = data.active_customers || '0';
            document.getElementById('pendingInvoices').textContent = data.pending_invoices || '0';
            document.getElementById('todayIncome').textContent = 'Rp ' + (data.today_income || '0');
            document.getElementById('monthlyIncome').textContent = 'Rp ' + (data.monthly_income || '0');
            
        } catch (error) {
            console.log('Error loading billing stats:', error);
        }
    }

    // Load stats on page load
    async function loadStats() {
        try {
            const response = await fetch('/api/stats');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.error) {
                showNotification('Failed to load stats: ' + data.error, 'error');
                return;
            }

            // Update stats
            document.getElementById('totalUsers').textContent = data.total_users || '0';
            document.getElementById('activeSessions').textContent = data.active_sessions || '0';
            document.getElementById('todayAuth').textContent = data.today_auth || '0';
            document.getElementById('totalNas').textContent = data.total_nas || '0';
            
            // Update timestamp
            updateTimestamp();
            
            // Update performance metrics
            updatePerformanceMetrics();
            
            // Load billing stats
            loadBillingStats();
            
        } catch (error) {
            console.error('Error loading stats:', error);
            showNotification('Failed to load stats: ' + error.message, 'error');
        }
    }

    // Manual refresh function
    window.refreshDashboard = function() {
        loadStats();
        showNotification('Dashboard refreshed', 'success');
    };

    // Auto-refresh every 10 seconds
    loadStats();
    setInterval(loadStats, 10000);

    // Update timestamp setiap 30 detik
    setInterval(updateTimestamp, 30000);

    // Update performance metrics setiap 15 detik
    setInterval(updatePerformanceMetrics, 15000);

    // Add refresh button event listener
    document.addEventListener('DOMContentLoaded', function() {
        // Add refresh button to header
        const header = document.querySelector('header .flex.items-center.space-x-4');
        if (header) {
            const refreshBtn = document.createElement('button');
            refreshBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg flex items-center space-x-2 transition-colors text-sm';
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i><span>Refresh</span>';
            refreshBtn.onclick = refreshDashboard;
            header.appendChild(refreshBtn);
        }

        // Initial load
        updateTimestamp();
        updatePerformanceMetrics();
        loadBillingStats();
    });
</script>
{% endblock %}
