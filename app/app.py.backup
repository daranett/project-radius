from flask import Flask, render_template, request, flash, redirect, url_for, jsonify
import psycopg2
import time
from config import Config

app = Flask(__name__)
app.config['SECRET_KEY'] = 'radius-dashboard-secret-2024'
app.config.from_object(Config)


# === DATABASE CONNECTION ===
def get_db_connection():
    return psycopg2.connect(
        host=app.config['DB_HOST'],
        database=app.config['DB_NAME'],
        user=app.config['DB_USER'],
        password=app.config['DB_PASSWORD'],
        port=app.config['DB_PORT']
    )


def execute_query(query, params=None, fetch=True):
    conn = get_db_connection()
    cur = conn.cursor()
    try:
        cur.execute(query, params)
        if fetch:
            result = cur.fetchall()
            columns = [desc[0] for desc in cur.description]
            return [dict(zip(columns, row)) for row in result]
        else:
            conn.commit()
            return True
    except Exception as e:
        conn.rollback()
        raise e
    finally:
        cur.close()
        conn.close()


# === MAIN ROUTES ===
@app.route('/')
def dashboard():
    return render_template('dashboard.html')


@app.route('/nas')
def nas_page():
    return render_template('nas.html')


@app.route('/users')
def users_page():
    return render_template('users.html')


@app.route('/sessions')
def sessions_page():
    return render_template('sessions.html')


@app.route('/logs')
def logs_page():
    return render_template('logs.html')


# === API ROUTES ===
@app.route('/api/stats')
def api_stats():
    try:
        total_users = execute_query("SELECT COUNT(*) as count FROM radcheck")[0]['count']
        active_sessions = execute_query("SELECT COUNT(*) as count FROM radacct WHERE acctstoptime IS NULL")[0]['count']
        today_auth = execute_query("SELECT COUNT(*) as count FROM radpostauth WHERE DATE(authdate) = CURRENT_DATE")[0]['count']

        # Handle NAS count
        try:
            total_nas = execute_query("SELECT COUNT(*) as count FROM nas")[0]['count']
        except:
            total_nas = 0

        return jsonify({
            'total_users': total_users,
            'active_sessions': active_sessions,
            'today_auth': today_auth,
            'total_nas': total_nas
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/api/nas')
def api_nas():
    try:
        nas_list = execute_query("SELECT * FROM nas ORDER BY id")
        return jsonify(nas_list)
    except Exception as e:
        if 'relation "nas" does not exist' in str(e):
            return jsonify([])
        return jsonify({'error': str(e)}), 500


@app.route('/api/nas/add', methods=['POST'])
def api_add_nas():
    try:
        data = request.get_json()

        # Check if NAS table has the new columns
        try:
            execute_query("SELECT limit_proxy_state, require_ma FROM nas LIMIT 1")
            execute_query("""
                INSERT INTO nas (nasname, shortname, type, ports, secret, server, community, description, limit_proxy_state, require_ma)
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s, 'auto', 'auto')
            """, (
                data['nasname'], data['shortname'], data['type'], data['ports'],
                data['secret'], data.get('server', ''), data.get('community', ''), data.get('description', '')
            ), fetch=False)
        except:
            execute_query("""
                INSERT INTO nas (nasname, shortname, type, ports, secret, server, community, description)
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
            """, (
                data['nasname'], data['shortname'], data['type'], data['ports'],
                data['secret'], data.get('server', ''), data.get('community', ''), data.get('description', '')
            ), fetch=False)

        return jsonify({'success': True, 'message': 'NAS added successfully'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/nas/delete/<int:nas_id>', methods=['DELETE'])
def api_delete_nas(nas_id):
    try:
        execute_query("DELETE FROM nas WHERE id = %s", (nas_id,), fetch=False)
        return jsonify({'success': True, 'message': 'NAS deleted successfully'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/users')
def api_users():
    try:
        users = execute_query("""
            SELECT
                c.id,
                c.username,
                c.attribute,
                c.op,
                c.value as password,
                (SELECT value FROM radreply r1 WHERE r1.username = c.username AND r1.attribute = 'Framed-IP-Address' LIMIT 1) as ip_address,
                (SELECT value FROM radreply r2 WHERE r2.username = c.username AND r2.attribute = 'Mikrotik-Rate-Limit' LIMIT 1) as rate_limit,
                (SELECT value FROM radreply r3 WHERE r3.username = c.username AND r3.attribute = 'Session-Timeout' LIMIT 1) as session_timeout,
                (SELECT value FROM radreply r4 WHERE r4.username = c.username AND r4.attribute = 'Idle-Timeout' LIMIT 1) as idle_timeout,
                (SELECT COUNT(*) FROM radacct a WHERE a.username = c.username AND a.acctstoptime IS NULL) as active_sessions
            FROM radcheck c
            WHERE c.attribute = 'Cleartext-Password'
            ORDER BY c.username
        """)
        return jsonify(users)
    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/api/users/add', methods=['POST'])
def api_add_user():
    try:
        data = request.get_json()
        print(f"ðŸŸ¢ DEBUG: Starting to add user: {data['username']}")  # âœ… DEBUG

        # Add to radcheck - Password
        execute_query("""
            INSERT INTO radcheck (username, attribute, op, value)
            VALUES (%s, 'Cleartext-Password', ':=', %s)
        """, (data['username'], data['password']), fetch=False)
        print(f"ðŸŸ¢ DEBUG: radcheck inserted for {data['username']}")  # âœ… DEBUG

        # Add PPPoE attributes to radreply
        ppp_attributes = [
            ('Framed-Protocol', ':=', 'PPP'),
            ('Service-Type', ':=', 'Framed-User'),
            ('Framed-Compression', ':=', 'Van-Jacobson-TCP-IP')
        ]
        for attr, op, value in ppp_attributes:
            execute_query("""
                INSERT INTO radreply (username, attribute, op, value)
                VALUES (%s, %s, %s, %s)
            """, (data['username'], attr, op, value), fetch=False)
        print(f"ðŸŸ¢ DEBUG: PPP attributes added for {data['username']}")  # âœ… DEBUG

        # Add IP address if provided
        if data.get('ip_address'):
            execute_query("""
                INSERT INTO radreply (username, attribute, op, value)
                VALUES (%s, 'Framed-IP-Address', ':=', %s)
            """, (data['username'], data['ip_address']), fetch=False)
            print(f"ðŸŸ¢ DEBUG: IP address {data['ip_address']} added")  # âœ… DEBUG

        # Add rate limit if provided
        if data.get('rate_limit'):
            execute_query("""
                INSERT INTO radreply (username, attribute, op, value)
                VALUES (%s, 'Mikrotik-Rate-Limit', ':=', %s)
            """, (data['username'], data['rate_limit']), fetch=False)
            print(f"ðŸŸ¢ DEBUG: Rate limit {data['rate_limit']} added")  # âœ… DEBUG

        # Add session timeout if provided
        if data.get('session_timeout'):
            execute_query("""
                INSERT INTO radreply (username, attribute, op, value)
                VALUES (%s, 'Session-Timeout', ':=', %s)
            """, (data['username'], data['session_timeout']), fetch=False)

        # Add idle timeout if provided
        if data.get('idle_timeout'):
            execute_query("""
                INSERT INTO radreply (username, attribute, op, value)
                VALUES (%s, 'Idle-Timeout', ':=', %s)
            """, (data['username'], data['idle_timeout']), fetch=False)

        # Add data limit if provided
        if data.get('data_limit'):
            execute_query("""
                INSERT INTO radreply (username, attribute, op, value)
                VALUES (%s, 'Mikrotik-Total-Limit', ':=', %s)
            """, (data['username'], data['data_limit']), fetch=False)

        print(f"ðŸŸ¢ DEBUG: User {data['username']} added SUCCESSFULLY")  # âœ… DEBUG
        return jsonify({'success': True, 'message': 'User added successfully with all attributes'})
    except Exception as e:
        print(f"ðŸ”´ DEBUG: ERROR adding user: {str(e)}")  # âœ… DEBUG
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/users/delete/<int:user_id>', methods=['DELETE'])
def api_delete_user(user_id):
    try:
        user = execute_query("SELECT username FROM radcheck WHERE id = %s", (user_id,))
        if user:
            username = user[0]['username']
            execute_query("DELETE FROM radcheck WHERE username = %s", (username,), fetch=False)
            execute_query("DELETE FROM radreply WHERE username = %s", (username,), fetch=False)
            return jsonify({'success': True, 'message': 'User deleted successfully'})
        else:
            return jsonify({'success': False, 'error': 'User not found'}), 404
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/sessions')
def api_sessions():
    try:
        sessions = execute_query("""
            SELECT * FROM radacct
            WHERE acctstoptime IS NULL
            ORDER BY acctstarttime DESC
        """)
        return jsonify(sessions)
    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/api/logs')
def api_logs():
    try:
        logs = execute_query("""
            SELECT 
                id,
                username,
                reply,
                authdate,
                pass,
                calledstationid,
                callingstationid
            FROM radpostauth 
            ORDER BY authdate DESC 
            LIMIT 50
        """)
        return jsonify(logs)
    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/health')
def health():
    return 'OK'


if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
